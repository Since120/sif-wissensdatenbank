# NextAuth.js - Authentication Framework

NextAuth.js macht es einfach, sichere Authentifizierung hinzuzuf√ºgen.

## üîê √úberblick

NextAuth.js bietet:
- OAuth-Integration (Discord, Google, GitHub, etc.)
- Session Management
- JWT-Token Support
- CSRF-Schutz
- Flexible Callbacks

## üéØ Wie funktioniert's?

### Auth-Flow mit Discord

```
1. Benutzer klickt "Mit Discord anmelden"
   ‚îî‚îÄ Redirect zu /api/auth/signin?provider=discord

2. Redirect zu Discord OAuth URL
   ‚îî‚îÄ https://discord.com/api/oauth2/authorize?...

3. Benutzer authentifiziert sich bei Discord
   ‚îî‚îÄ Zustimmung zu Berechtigungen

4. Discord sendet Authorization Code zur√ºck
   ‚îî‚îÄ https://yourapp.com/api/auth/callback/discord?code=...

5. Backend tauscht Code gegen User Info
   ‚îî‚îÄ POST zu https://discord.com/api/oauth2/token

6. Benutzer wird in Session gespeichert
   ‚îî‚îÄ JWT-Token wird generiert und im Cookie gespeichert

7. Redirect zur callbackUrl
   ‚îî‚îÄ Benutzer ist nun eingeloggt ‚úÖ
```

## üìã Setup Discord OAuth

### Schritt 1: Discord Developer Portal

1. Gehe zu https://discord.com/developers/applications
2. Klicke "New Application"
3. Gib einen Namen ein (z.B. "Wissensdatenbank")
4. Unter "OAuth2" ‚Üí "General"
5. Kopiere **Client ID** und **Client Secret**

### Schritt 2: Redirect URIs

Unter "OAuth2" ‚Üí "Redirects" hinzuf√ºgen:

- `http://localhost:3000/api/auth/callback/discord` (Development)
- `https://yourdomain.com/api/auth/callback/discord` (Production)

### Schritt 3: .env.local

```bash
DISCORD_CLIENT_ID=your_client_id_here
DISCORD_CLIENT_SECRET=your_client_secret_here
NEXTAUTH_SECRET=openssl rand -base64 32
NEXTAUTH_URL=http://localhost:3000
```

## üîß Konfiguration

### [...nextauth].ts

```typescript
import NextAuth from 'next-auth'
import DiscordProvider from 'next-auth/providers/discord'

export const authOptions = {
  providers: [
    DiscordProvider({
      clientId: process.env.DISCORD_CLIENT_ID,
      clientSecret: process.env.DISCORD_CLIENT_SECRET,
    }),
  ],
  pages: {
    signIn: '/login',
    signOut: '/',
    error: '/auth/error',
  },
}

export default NextAuth(authOptions)
```

## üîå Verwendung in Komponenten

### Hook: useSession

```typescript
import { useSession, signIn, signOut } from 'next-auth/react'

export function UserProfile() {
  const { data: session, status } = useSession()

  if (status === 'loading') return <p>L√§dt...</p>
  if (status === 'unauthenticated') return <p>Nicht eingeloggt</p>

  return (
    <div>
      <p>Willkommen, {session?.user?.name}!</p>
      <button onClick={() => signOut()}>Logout</button>
    </div>
  )
}
```

### SessionProvider

```typescript
// pages/_app.tsx
import { SessionProvider } from 'next-auth/react'

export default function App({
  Component,
  pageProps: { session, ...pageProps },
}) {
  return (
    <SessionProvider session={session}>
      <Component {...pageProps} />
    </SessionProvider>
  )
}
```

## üõ°Ô∏è Seiten-Schutz

### Mit Middleware

```typescript
// middleware.ts
import { withAuth } from 'next-auth/middleware'

export const middleware = withAuth(function middleware(req) {
  return undefined
})

export const config = {
  matcher: ['/docs/:path*'], // Sch√ºtze /docs/* Seiten
}
```

### In API Routes

```typescript
// pages/api/protected.ts
import { getSession } from 'next-auth/react'

export default async function handler(req, res) {
  const session = await getSession({ req })

  if (!session) {
    res.status(401).json({ error: 'Unauthorized' })
    return
  }

  // Gesch√ºtzter Code
  res.status(200).json({ message: 'Success' })
}
```

## üîê Session-Objekt

```typescript
// Standard Session
{
  user: {
    name: "Discord Username",
    email: "user@discord.com",
    image: "avatar-url"
  },
  expires: "2024-12-31T23:59:59.999Z"
}

// Mit Custom Fields
{
  user: {
    id: "123456", // Discord User ID
    name: "Discord Username",
    email: "user@discord.com",
    image: "avatar-url"
  },
  expires: "2024-12-31T23:59:59.999Z"
}
```

## üîÑ Callbacks

### JWT Callback

```typescript
callbacks: {
  async jwt({ token, account }) {
    if (account) {
      token.id = account.providerAccountId
    }
    return token
  },
}
```

### Session Callback

```typescript
callbacks: {
  async session({ session, token }) {
    if (session.user) {
      session.user.id = token.id
    }
    return session
  },
}
```

## ‚öôÔ∏è Erweiterte Optionen

### Session-Lebensdauer

```typescript
session: {
  strategy: 'jwt',        // oder 'database'
  maxAge: 30 * 24 * 60 * 60, // 30 Tage
  updateAge: 24 * 60 * 60,   // Update nach 24h
}
```

### CSRF-Schutz

```typescript
// Automatisch aktiviert!
// NextAuth.js generiert einen CSRF-Token f√ºr POST-Requests
```

### Events

```typescript
events: {
  async signIn(message) {
    console.log('Benutzer hat sich angemeldet')
  },
  async signOut(message) {
    console.log('Benutzer hat sich abgemeldet')
  },
}
```

## üêõ H√§ufige Probleme

### Problem: "Invalid redirect URL"

**L√∂sung**: Stelle sicher, dass die `NEXTAUTH_URL` der aktuellen URL entspricht.

```bash
NEXTAUTH_URL=https://yourdomain.com
```

### Problem: "Session is undefined"

**L√∂sung**: Stelle sicher, dass `SessionProvider` in `_app.tsx` wrappet.

```typescript
<SessionProvider session={session}>
  <Component {...pageProps} />
</SessionProvider>
```

### Problem: CORS-Fehler

**L√∂sung**: NextAuth.js l√§uft auf demselben Origin, kein CORS n√∂tig!

---

**NextAuth.js macht Authentifizierung sicher und einfach!** üîê
